# Nacos 模块测试用例设计文档

## 一、测试目标

验证 Nacos 模块的核心功能是否正常工作，包括：
1. NacosConfig 配置类是否正确加载
2. @EnableDiscoveryClient 注解是否生效
3. Nacos 服务发现功能是否正常（服务注册、服务发现、服务注销）
4. Nacos 配置中心功能是否正常（配置读取、配置刷新、配置监听）
5. 配置属性是否正确生效
6. Nacos 连接异常处理是否正常

## 二、测试用例设计

### 2.1 NacosConfig 配置类测试用例

#### TC-001: 测试 NacosConfig Bean 创建
- **测试目的**: 验证 `NacosConfig` 配置类能正确创建 Bean
- **测试步骤**:
  1. 启动 Spring 上下文
  2. 获取 `NacosConfig` Bean
  3. 验证 Bean 不为空
  4. 验证 Bean 类型为 `NacosConfig`
- **预期结果**: NacosConfig Bean 创建成功

#### TC-002: 测试 @EnableDiscoveryClient 注解生效
- **测试目的**: 验证 `@EnableDiscoveryClient` 注解是否正确启用服务发现功能
- **测试步骤**:
  1. 启动 Spring 上下文
  2. 验证 `DiscoveryClient` Bean 存在
  3. 验证 `NacosServiceDiscovery` 或相关服务发现 Bean 存在
  4. 验证服务发现功能已启用
- **预期结果**: 服务发现功能已启用，相关 Bean 创建成功

#### TC-003: 测试配置类条件注解
- **测试目的**: 验证配置类在缺少 Nacos 依赖时的处理
- **测试步骤**:
  1. 移除 Nacos 相关依赖（模拟场景）
  2. 启动 Spring 上下文
  3. 验证应用是否能正常启动（或抛出明确的异常）
- **预期结果**: 应用启动失败并抛出明确的异常，说明缺少 Nacos 依赖

### 2.2 Nacos 服务发现功能测试用例

#### TC-004: 测试服务注册功能
- **测试目的**: 验证应用能否成功注册到 Nacos 服务注册中心
- **测试步骤**:
  1. 配置 Nacos 服务器地址（本地 Docker 或测试环境）
  2. 配置服务名称和应用信息
  3. 启动 Spring 上下文
  4. 等待服务注册完成
  5. 通过 Nacos 控制台或 API 验证服务是否已注册
  6. 验证服务实例信息（IP、端口、元数据等）是否正确
- **预期结果**: 服务成功注册到 Nacos，服务实例信息正确

#### TC-005: 测试服务发现功能
- **测试目的**: 验证应用能否从 Nacos 发现其他服务
- **测试步骤**:
  1. 在 Nacos 中预先注册一个测试服务
  2. 启动 Spring 上下文
  3. 使用 `DiscoveryClient` 查询服务列表
  4. 验证能发现已注册的测试服务
  5. 验证服务实例信息正确
- **预期结果**: 能成功发现已注册的服务，服务实例信息正确

#### TC-006: 测试服务注销功能
- **测试目的**: 验证应用关闭时能否正确注销服务
- **测试步骤**:
  1. 启动 Spring 上下文并注册服务
  2. 验证服务已注册
  3. 关闭 Spring 上下文
  4. 等待一段时间（服务注销需要时间）
  5. 通过 Nacos 控制台或 API 验证服务是否已注销
- **预期结果**: 服务成功注销，Nacos 中不再显示该服务实例

#### TC-007: 测试服务注册（register-enabled=false）
- **测试目的**: 验证当 `register-enabled=false` 时，服务不会注册
- **测试步骤**:
  1. 配置 `spring.cloud.nacos.discovery.register-enabled=false`
  2. 启动 Spring 上下文
  3. 通过 Nacos 控制台或 API 验证服务未注册
  4. 验证应用仍能正常启动
- **预期结果**: 服务未注册到 Nacos，但应用正常启动

#### TC-008: 测试命名空间隔离
- **测试目的**: 验证不同命名空间的服务是否隔离
- **测试步骤**:
  1. 在命名空间 A 中注册服务 A
  2. 在命名空间 B 中注册服务 B
  3. 使用命名空间 A 的配置查询服务
  4. 验证只能发现命名空间 A 中的服务
  5. 使用命名空间 B 的配置查询服务
  6. 验证只能发现命名空间 B 中的服务
- **预期结果**: 不同命名空间的服务完全隔离，互不可见

#### TC-009: 测试服务分组功能
- **测试目的**: 验证服务分组功能是否正常
- **测试步骤**:
  1. 配置服务分组为 `TEST_GROUP`
  2. 注册服务到指定分组
  3. 使用 `DiscoveryClient` 查询指定分组的服务
  4. 验证能正确查询到分组内的服务
  5. 验证其他分组的服务不可见
- **预期结果**: 服务分组功能正常，分组隔离生效

### 2.3 Nacos 配置中心功能测试用例

#### TC-010: 测试配置读取功能
- **测试目的**: 验证应用能否从 Nacos 配置中心读取配置
- **测试步骤**:
  1. 在 Nacos 配置中心创建测试配置文件（dataId: test-config.yaml）
  2. 配置应用读取该配置文件
  3. 启动 Spring 上下文
  4. 使用 `@Value` 或 `@ConfigurationProperties` 注入配置值
  5. 验证配置值是否正确读取
- **预期结果**: 配置成功读取，配置值正确

#### TC-011: 测试配置刷新功能
- **测试目的**: 验证配置刷新功能是否正常
- **测试步骤**:
  1. 在 Nacos 配置中心创建配置文件并设置 `refresh: true`
  2. 启动 Spring 上下文并读取配置
  3. 在 Nacos 控制台修改配置值
  4. 等待配置刷新（通常几秒内）
  5. 验证配置值已更新
  6. 验证 `@RefreshScope` 注解的 Bean 已重新加载
- **预期结果**: 配置自动刷新，新配置值生效

#### TC-012: 测试配置监听功能
- **测试目的**: 验证配置变更监听功能是否正常
- **测试步骤**:
  1. 在 Nacos 配置中心创建配置文件
  2. 使用 `@NacosConfigListener` 或 `ConfigService` 监听配置变更
  3. 启动 Spring 上下文
  4. 在 Nacos 控制台修改配置
  5. 验证监听器被触发
  6. 验证监听器能获取到新的配置值
- **预期结果**: 配置变更监听器被正确触发，能获取新配置值

#### TC-013: 测试共享配置文件
- **测试目的**: 验证共享配置文件功能是否正常
- **测试步骤**:
  1. 在 Nacos 配置中心创建共享配置文件（如 `shared-config.yaml`）
  2. 配置 `shared-configs` 属性指向该文件
  3. 启动 Spring 上下文
  4. 验证共享配置能被正确读取
  5. 验证多个应用可以共享同一配置
- **预期结果**: 共享配置文件成功读取，多个应用可以共享配置

#### TC-014: 测试配置文件扩展名
- **测试目的**: 验证不同扩展名的配置文件是否能正确读取
- **测试步骤**:
  1. 在 Nacos 配置中心创建不同扩展名的配置文件（.yaml, .yml, .properties）
  2. 配置 `file-extension` 属性
  3. 启动 Spring 上下文
  4. 验证对应扩展名的配置文件能被正确读取
- **预期结果**: 不同扩展名的配置文件都能正确读取

#### TC-015: 测试配置前缀功能
- **测试目的**: 验证配置前缀功能是否正常
- **测试步骤**:
  1. 配置 `prefix: test-app`
  2. 在 Nacos 配置中心创建配置文件（dataId: test-app.yaml）
  3. 启动 Spring 上下文
  4. 验证能正确读取以 prefix 为前缀的配置文件
- **预期结果**: 配置前缀功能正常，能正确读取对应配置文件

### 2.4 Nacos 连接和异常处理测试用例

#### TC-016: 测试 Nacos 服务器连接成功
- **测试目的**: 验证应用能成功连接到 Nacos 服务器
- **测试步骤**:
  1. 确保 Nacos 服务器正常运行
  2. 配置正确的 Nacos 服务器地址
  3. 启动 Spring 上下文
  4. 验证应用能成功连接
  5. 验证日志中无连接错误
- **预期结果**: 应用成功连接到 Nacos 服务器，无连接错误

#### TC-017: 测试 Nacos 服务器连接失败
- **测试目的**: 验证当 Nacos 服务器不可用时，应用的处理逻辑
- **测试步骤**:
  1. 配置错误的 Nacos 服务器地址（或停止 Nacos 服务器）
  2. 启动 Spring 上下文
  3. 验证应用启动行为（可能启动失败或启动成功但功能不可用）
  4. 验证日志中输出明确的错误信息
- **预期结果**: 应用能正确处理连接失败，输出明确的错误信息

#### TC-018: 测试 Nacos 服务器连接超时
- **测试目的**: 验证 Nacos 连接超时的处理
- **测试步骤**:
  1. 配置一个不可达的 Nacos 服务器地址
  2. 设置合理的超时时间
  3. 启动 Spring 上下文
  4. 验证超时后应用的处理逻辑
  5. 验证日志中输出超时错误信息
- **预期结果**: 连接超时后应用能正确处理，输出超时错误信息

#### TC-019: 测试 Nacos 认证功能（accessKey/secretKey）
- **测试目的**: 验证 Nacos 认证功能是否正常
- **测试步骤**:
  1. 配置 Nacos 服务器的 accessKey 和 secretKey
  2. 启动 Spring 上下文
  3. 验证能成功连接并认证
  4. 验证服务注册和配置读取功能正常
- **预期结果**: 认证成功，功能正常

#### TC-020: 测试 Nacos 认证失败
- **测试目的**: 验证认证失败时的处理
- **测试步骤**:
  1. 配置错误的 accessKey 或 secretKey
  2. 启动 Spring 上下文
  3. 验证应用启动行为
  4. 验证日志中输出认证失败错误信息
- **预期结果**: 认证失败时应用能正确处理，输出明确的错误信息

### 2.5 配置属性测试用例

#### TC-021: 测试服务发现配置属性
- **测试目的**: 验证服务发现相关配置属性是否正确生效
- **测试步骤**:
  1. 配置服务发现相关属性（server-addr, namespace, service, group 等）
  2. 启动 Spring 上下文
  3. 获取 `NacosDiscoveryProperties` Bean
  4. 验证配置属性值是否正确
- **预期结果**: 配置属性正确生效

#### TC-022: 测试配置中心配置属性
- **测试目的**: 验证配置中心相关配置属性是否正确生效
- **测试步骤**:
  1. 配置配置中心相关属性（server-addr, namespace, prefix, file-extension 等）
  2. 启动 Spring 上下文
  3. 获取 `NacosConfigProperties` Bean
  4. 验证配置属性值是否正确
- **预期结果**: 配置属性正确生效

#### TC-023: 测试配置属性默认值
- **测试目的**: 验证配置属性的默认值是否正确
- **测试步骤**:
  1. 不配置某些可选属性（如 group, file-extension 等）
  2. 启动 Spring 上下文
  3. 验证使用默认值（如 group=DEFAULT_GROUP, file-extension=properties）
- **预期结果**: 默认值正确生效

## 三、测试环境要求

1. **测试框架**: 
   - JUnit 5
   - Spring Boot Test
   - Mockito（用于模拟 Nacos 服务器）

2. **Nacos 服务器**: 
   - 使用本地 Docker 容器运行 Nacos 服务器（推荐）
   - 或使用 Testcontainers 创建临时 Nacos 容器
   - 或连接测试环境的 Nacos 服务器

3. **测试配置**:
   - 使用 `@TestConfiguration` 提供测试配置
   - 使用 `@SpringBootTest` 进行集成测试
   - 使用 `@MockBean` 模拟 Nacos 客户端（如需要）
   - 使用 `@TestPropertySource` 覆盖测试配置

4. **Docker 环境**:
   - 需要 Docker 环境运行 Nacos 服务器
   - Nacos 服务器地址：`localhost:8848`
   - 默认用户名/密码：`nacos/nacos`

## 四、测试数据准备

1. **测试服务**: 创建测试服务用于服务发现测试
2. **测试配置**: 在 Nacos 配置中心创建测试配置文件
3. **测试命名空间**: 创建测试命名空间用于隔离测试
4. **测试分组**: 创建测试分组用于分组测试

## 五、测试用例与代码对应关系

### 5.1 已实现的测试用例

| 测试用例ID | 测试用例名称 | 实现类 | 状态 |
|-----------|------------|--------|------|
| TC-001 | 测试 NacosConfig Bean 创建 | NacosConfigTest | ✅ 已实现 |
| TC-002 | 测试 @EnableDiscoveryClient 注解生效 | NacosConfigTest | ✅ 已实现 |
| TC-003 | 测试配置类条件注解 | NacosConfigTest | ✅ 已实现 |
| TC-004 | 测试服务注册功能 | NacosDiscoveryTest | ✅ 已实现 |
| TC-005 | 测试服务发现功能 | NacosDiscoveryTest | ✅ 已实现 |
| TC-006 | 测试服务注销功能 | NacosDiscoveryTest | ✅ 已实现 |
| TC-007 | 测试服务注册（register-enabled=false） | NacosDiscoveryDisabledTest | ✅ 已实现 |
| TC-008 | 测试命名空间隔离 | NacosNamespaceIsolationTest | ✅ 已实现 |
| TC-009 | 测试服务分组功能 | NacosServiceGroupTest | ✅ 已实现 |
| TC-010 | 测试配置读取功能 | NacosConfigCenterTest | ✅ 已实现 |
| TC-011 | 测试配置刷新功能 | NacosConfigCenterTest | ✅ 已实现 |
| TC-012 | 测试配置监听功能 | NacosConfigCenterTest | ✅ 已实现 |
| TC-013 | 测试共享配置文件 | NacosSharedConfigTest | ✅ 已实现 |
| TC-014 | 测试配置文件扩展名 | NacosConfigFileExtensionTest | ✅ 已实现 |
| TC-015 | 测试配置前缀功能 | NacosConfigPrefixTest | ✅ 已实现 |
| TC-016 | 测试 Nacos 服务器连接成功 | NacosConnectionTest | ✅ 已实现 |
| TC-017 | 测试 Nacos 服务器连接失败 | NacosConnectionFailureTest | ✅ 已实现 |
| TC-018 | 测试 Nacos 服务器连接超时 | NacosConnectionTimeoutTest | ✅ 已实现 |
| TC-019 | 测试 Nacos 认证功能 | NacosAuthenticationTest | ✅ 已实现 |
| TC-020 | 测试 Nacos 认证失败 | NacosAuthenticationFailureTest | ✅ 已实现 |
| TC-021 | 测试服务发现配置属性 | NacosDiscoveryPropertiesTest | ✅ 已实现 |
| TC-022 | 测试配置中心配置属性 | NacosConfigPropertiesTest | ✅ 已实现 |
| TC-023 | 测试配置属性默认值 | NacosPropertiesTest | ✅ 已实现 |

### 5.2 待实现的测试用例

目前所有测试用例（TC-001 到 TC-023）均已实现。

### 5.3 测试实现建议

1. **NacosConfigTest**：
   - 测试 NacosConfig 配置类的基本功能
   - 验证 Bean 创建和注解生效
   - 可以使用 Mock 方式，不依赖真实的 Nacos 服务器

2. **NacosDiscoveryTest**：
   - 测试服务发现相关功能
   - 需要连接真实的 Nacos 服务器（Docker 容器）
   - 测试前需要确保 Nacos 服务器正常运行

3. **NacosConfigCenterTest**：
   - 测试配置中心相关功能
   - 需要连接真实的 Nacos 服务器
   - 需要在 Nacos 中预先创建测试配置

4. **NacosConnectionTest**：
   - 测试连接和异常处理
   - 需要模拟不同的连接场景（成功、失败、超时）
   - 可以使用 Mock 或真实的 Nacos 服务器

5. **NacosPropertiesTest**：
   - 测试配置属性
   - 可以使用 Mock 方式，不依赖真实的 Nacos 服务器

## 六、注意事项

1. **Nacos 服务器依赖**：
   - 大部分测试用例需要连接真实的 Nacos 服务器
   - 建议使用 Docker 容器运行 Nacos 服务器
   - 测试前需要确保 Nacos 服务器正常运行
   - 可以使用 Testcontainers 在测试时自动启动 Nacos 容器

2. **测试隔离性**：
   - 使用独立的命名空间进行测试，避免影响其他测试
   - 每个测试用例使用唯一的服务名称
   - 测试结束后清理测试数据

3. **配置管理**：
   - 测试配置应该与生产配置分离
   - 使用 `@TestPropertySource` 覆盖测试配置
   - 测试配置应该指向测试环境的 Nacos 服务器

4. **异步操作**：
   - 服务注册和配置刷新是异步操作，需要等待一段时间
   - 测试中需要添加适当的等待时间或使用轮询机制

5. **资源清理**：
   - 测试结束后需要清理注册的服务
   - 清理 Nacos 配置中心中的测试配置
   - 避免测试数据污染

6. **Docker 环境**：
   - 确保 Docker 环境正常运行
   - 确保 Nacos 容器正常运行
   - 如果使用 Testcontainers，需要确保网络连接正常

7. **认证配置**：
   - 如果 Nacos 服务器启用了认证，需要在测试配置中提供正确的 accessKey 和 secretKey
   - 测试认证失败场景时，使用错误的认证信息

8. **性能考虑**：
   - 连接 Nacos 服务器和注册服务需要时间，测试中需要合理设置超时时间
   - 避免在测试中频繁启动和关闭 Spring 上下文

