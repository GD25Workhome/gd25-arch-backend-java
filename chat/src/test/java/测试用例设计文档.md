# Chat 模块测试用例设计文档

## 一、测试目标

验证 Chat 模块的核心功能是否正常工作，包括：
1. ChatClientConfig 配置类是否正确加载
2. DeepSeek ChatClient Bean 创建是否正确
3. ZhiPuAI ChatClient Bean 创建是否正确
4. 条件注解 `@ConditionalOnProperty` 是否正确生效
5. 配置属性是否正确生效
6. 多个 ChatClient 共存场景是否正常
7. 缺少配置时的处理是否正常

## 二、测试用例设计

### 2.1 ChatClientConfig 配置类测试用例

#### TC-001: 测试 ChatClientConfig Bean 创建
- **测试目的**: 验证 `ChatClientConfig` 配置类能正确创建 Bean
- **测试步骤**:
  1. 启动 Spring 上下文
  2. 获取 `ChatClientConfig` Bean
  3. 验证 Bean 不为空
  4. 验证 Bean 类型为 `ChatClientConfig`
- **预期结果**: ChatClientConfig Bean 创建成功

#### TC-002: 测试配置类上的 @Configuration 注解
- **测试目的**: 验证配置类标注了 `@Configuration` 注解
- **测试步骤**:
  1. 启动 Spring 上下文
  2. 获取 `ChatClientConfig` Bean
  3. 验证类上存在 `@Configuration` 注解
- **预期结果**: 配置类正确标注了 `@Configuration` 注解

### 2.2 DeepSeek ChatClient 测试用例

#### TC-003: 测试 DeepSeek ChatClient Bean 创建（配置了 api-key）
- **测试目的**: 验证当配置了 `spring.ai.deepseek.api-key` 时，DeepSeek ChatClient Bean 被创建
- **测试步骤**:
  1. 配置 `spring.ai.deepseek.api-key=test-key`
  2. 启动 Spring 上下文
  3. 获取 `ChatClient` Bean（通过名称 `deepSeekChatClient` 或类型）
  4. 验证 Bean 不为空
  5. 验证 Bean 类型为 `ChatClient`
- **预期结果**: DeepSeek ChatClient Bean 创建成功

#### TC-004: 测试 DeepSeek ChatClient Bean 不创建（未配置 api-key）
- **测试目的**: 验证当未配置 `spring.ai.deepseek.api-key` 时，DeepSeek ChatClient Bean 不被创建
- **测试步骤**:
  1. 不配置 `spring.ai.deepseek.api-key` 或配置为空
  2. 启动 Spring 上下文
  3. 尝试获取 `ChatClient` Bean（通过名称 `deepSeekChatClient`）
  4. 验证 Bean 不存在（使用 `@Autowired(required = false)` 或 `Optional`）
- **预期结果**: DeepSeek ChatClient Bean 未被创建

#### TC-005: 测试 DeepSeek ChatClient 条件注解匹配规则
- **测试目的**: 验证 `@ConditionalOnProperty(prefix = "spring.ai.deepseek", name = "api-key")` 的匹配规则
- **测试步骤**:
  1. 配置 `spring.ai.deepseek.api-key=test-key`
  2. 启动 Spring 上下文
  3. 验证 Bean 存在
  4. 修改配置为 `spring.ai.deepseek.api-key=`（空字符串）
  5. 重新启动 Spring 上下文
  6. 验证 Bean 不存在
- **预期结果**: 只有当 api-key 有值时，Bean 才被创建

#### TC-006: 测试 DeepSeek ChatClient 依赖注入
- **测试目的**: 验证 `deepSeekChatClient` 方法能正确注入 `DeepSeekChatModel` 依赖
- **测试步骤**:
  1. 配置 `spring.ai.deepseek.api-key=test-key`
  2. 配置 DeepSeek 相关属性（base-url、model 等）
  3. 启动 Spring 上下文
  4. 验证 `DeepSeekChatModel` Bean 存在
  5. 验证 `deepSeekChatClient` Bean 创建成功
  6. 验证 ChatClient 能正常工作（可选，需要 mock API 调用）
- **预期结果**: 依赖注入成功，ChatClient Bean 创建成功

#### TC-007: 测试 DeepSeek ChatClient 配置属性
- **测试目的**: 验证 DeepSeek 相关配置属性是否正确生效
- **测试步骤**:
  1. 配置完整的 DeepSeek 属性：
     - `spring.ai.deepseek.api-key=test-key`
     - `spring.ai.deepseek.base-url=https://api.deepseek.com`
     - `spring.ai.deepseek.chat.options.model=deepseek-chat`
     - `spring.ai.deepseek.chat.options.temperature=0.7`
  2. 启动 Spring 上下文
  3. 获取 `DeepSeekChatModel` Bean
  4. 验证配置属性已正确应用（通过反射或 Bean 属性检查）
- **预期结果**: 所有配置属性正确生效

### 2.3 ZhiPuAI ChatClient 测试用例

#### TC-008: 测试 ZhiPuAI ChatClient Bean 创建（配置了 api-key）
- **测试目的**: 验证当配置了 `spring.ai.zhipuai.api-key` 时，ZhiPuAI ChatClient Bean 被创建
- **测试步骤**:
  1. 配置 `spring.ai.zhipuai.api-key=test-key`
  2. 启动 Spring 上下文
  3. 获取 `ChatClient` Bean（通过名称 `zhiPuAiChatClient` 或类型）
  4. 验证 Bean 不为空
  5. 验证 Bean 类型为 `ChatClient`
- **预期结果**: ZhiPuAI ChatClient Bean 创建成功

#### TC-009: 测试 ZhiPuAI ChatClient Bean 不创建（未配置 api-key）
- **测试目的**: 验证当未配置 `spring.ai.zhipuai.api-key` 时，ZhiPuAI ChatClient Bean 不被创建
- **测试步骤**:
  1. 不配置 `spring.ai.zhipuai.api-key` 或配置为空
  2. 启动 Spring 上下文
  3. 尝试获取 `ChatClient` Bean（通过名称 `zhiPuAiChatClient`）
  4. 验证 Bean 不存在（使用 `@Autowired(required = false)` 或 `Optional`）
- **预期结果**: ZhiPuAI ChatClient Bean 未被创建

#### TC-010: 测试 ZhiPuAI ChatClient 条件注解匹配规则
- **测试目的**: 验证 `@ConditionalOnProperty(prefix = "spring.ai.zhipuai", name = "api-key")` 的匹配规则
- **测试步骤**:
  1. 配置 `spring.ai.zhipuai.api-key=test-key`
  2. 启动 Spring 上下文
  3. 验证 Bean 存在
  4. 修改配置为 `spring.ai.zhipuai.api-key=`（空字符串）
  5. 重新启动 Spring 上下文
  6. 验证 Bean 不存在
- **预期结果**: 只有当 api-key 有值时，Bean 才被创建

#### TC-011: 测试 ZhiPuAI ChatClient 依赖注入
- **测试目的**: 验证 `zhiPuAiChatClient` 方法能正确注入 `ZhiPuAiChatModel` 依赖
- **测试步骤**:
  1. 配置 `spring.ai.zhipuai.api-key=test-key`
  2. 配置 ZhiPuAI 相关属性（base-url、model 等）
  3. 启动 Spring 上下文
  4. 验证 `ZhiPuAiChatModel` Bean 存在
  5. 验证 `zhiPuAiChatClient` Bean 创建成功
  6. 验证 ChatClient 能正常工作（可选，需要 mock API 调用）
- **预期结果**: 依赖注入成功，ChatClient Bean 创建成功

#### TC-012: 测试 ZhiPuAI ChatClient 配置属性
- **测试目的**: 验证 ZhiPuAI 相关配置属性是否正确生效
- **测试步骤**:
  1. 配置完整的 ZhiPuAI 属性：
     - `spring.ai.zhipuai.api-key=test-key`
     - `spring.ai.zhipuai.base-url=https://open.bigmodel.cn/api/paas`
     - `spring.ai.zhipuai.chat.options.model=glm-4-plus`
  2. 启动 Spring 上下文
  3. 获取 `ZhiPuAiChatModel` Bean
  4. 验证配置属性已正确应用（通过反射或 Bean 属性检查）
- **预期结果**: 所有配置属性正确生效

### 2.4 多个 ChatClient 共存测试用例

#### TC-013: 测试同时配置两个 ChatClient
- **测试目的**: 验证当同时配置了 DeepSeek 和 ZhiPuAI 的 api-key 时，两个 ChatClient Bean 都能创建
- **测试步骤**:
  1. 同时配置：
     - `spring.ai.deepseek.api-key=test-deepseek-key`
     - `spring.ai.zhipuai.api-key=test-zhipuai-key`
  2. 启动 Spring 上下文
  3. 获取 `deepSeekChatClient` Bean，验证不为空
  4. 获取 `zhiPuAiChatClient` Bean，验证不为空
  5. 验证两个 Bean 是不同的实例
  6. 验证两个 Bean 的类型都是 `ChatClient`
- **预期结果**: 两个 ChatClient Bean 都创建成功，且是不同的实例

#### TC-014: 测试通过 Bean 名称获取不同的 ChatClient
- **测试目的**: 验证可以通过不同的 Bean 名称获取对应的 ChatClient
- **测试步骤**:
  1. 同时配置两个 api-key
  2. 启动 Spring 上下文
  3. 通过 `@Qualifier("deepSeekChatClient")` 获取 DeepSeek ChatClient
  4. 通过 `@Qualifier("zhiPuAiChatClient")` 获取 ZhiPuAI ChatClient
  5. 验证获取到的 Bean 不为空且类型正确
- **预期结果**: 可以通过 Bean 名称正确获取对应的 ChatClient

#### TC-015: 测试只配置一个 ChatClient 时的 Bean 数量
- **测试目的**: 验证只配置一个 api-key 时，只有一个 ChatClient Bean 被创建
- **测试步骤**:
  1. 只配置 `spring.ai.deepseek.api-key=test-key`
  2. 启动 Spring 上下文
  3. 获取所有 `ChatClient` 类型的 Bean（使用 `ApplicationContext.getBeansOfType`）
  4. 验证只有一个 ChatClient Bean
  5. 验证该 Bean 的名称为 `deepSeekChatClient`
- **预期结果**: 只有一个 ChatClient Bean 被创建

### 2.5 条件注解和配置属性测试用例

#### TC-016: 测试条件注解的 prefix 和 name 匹配
- **测试目的**: 验证 `@ConditionalOnProperty` 的 prefix 和 name 参数是否正确匹配配置属性
- **测试步骤**:
  1. 测试 DeepSeek：
     - 配置 `spring.ai.deepseek.api-key=test-key`，验证 Bean 存在
     - 配置 `spring.ai.deepseek.api-key-other=test-key`，验证 Bean 不存在
  2. 测试 ZhiPuAI：
     - 配置 `spring.ai.zhipuai.api-key=test-key`，验证 Bean 存在
     - 配置 `spring.ai.zhipuai.api-key-other=test-key`，验证 Bean 不存在
- **预期结果**: 只有完全匹配 prefix 和 name 的配置才能创建 Bean

#### TC-017: 测试条件注解的默认值处理
- **测试目的**: 验证 `@ConditionalOnProperty` 在配置不存在时的默认行为
- **测试步骤**:
  1. 不配置任何 `spring.ai.deepseek.api-key` 和 `spring.ai.zhipuai.api-key`
  2. 启动 Spring 上下文
  3. 验证两个 ChatClient Bean 都不存在
- **预期结果**: 当配置不存在时，Bean 不被创建（默认 `matchIfMissing = false`）

#### TC-018: 测试配置属性为空字符串的处理
- **测试目的**: 验证当 api-key 配置为空字符串时的处理
- **测试步骤**:
  1. 配置 `spring.ai.deepseek.api-key=`（空字符串）
  2. 启动 Spring 上下文
  3. 验证 `deepSeekChatClient` Bean 不存在
  4. 配置 `spring.ai.zhipuai.api-key=`（空字符串）
  5. 重新启动 Spring 上下文
  6. 验证 `zhiPuAiChatClient` Bean 不存在
- **预期结果**: 空字符串被视为无效配置，Bean 不被创建

### 2.6 异常场景测试用例

#### TC-019: 测试缺少 ChatModel Bean 时的处理
- **测试目的**: 验证当缺少 `DeepSeekChatModel` 或 `ZhiPuAiChatModel` Bean 时的异常处理
- **测试步骤**:
  1. 配置 `spring.ai.deepseek.api-key=test-key`
  2. 但不配置必要的 DeepSeek 属性（如 base-url），导致 `DeepSeekChatModel` Bean 无法创建
  3. 启动 Spring 上下文
  4. 验证应用启动失败并抛出明确的异常（如 `NoSuchBeanDefinitionException`）
- **预期结果**: 应用启动失败，抛出明确的异常说明缺少必要的 Bean

#### TC-020: 测试配置错误的 base-url 时的处理
- **测试目的**: 验证当配置了错误的 base-url 时的处理（不测试实际 API 调用）
- **测试步骤**:
  1. 配置 `spring.ai.deepseek.api-key=test-key`
  2. 配置 `spring.ai.deepseek.base-url=invalid-url`
  3. 启动 Spring 上下文
  4. 验证应用是否能正常启动（配置验证可能在运行时进行）
  5. 验证 `DeepSeekChatModel` Bean 是否创建（取决于 Spring AI 的配置验证机制）
- **预期结果**: 根据 Spring AI 的实现，可能启动成功但运行时失败，或启动时验证失败

#### TC-021: 测试缺少依赖时的处理
- **测试目的**: 验证当缺少 Spring AI 依赖时的处理
- **测试步骤**:
  1. 模拟缺少 `spring-ai-starter-model-deepseek` 依赖的场景
  2. 启动 Spring 上下文
  3. 验证应用启动失败并抛出明确的异常（如 `ClassNotFoundException`）
- **预期结果**: 应用启动失败，抛出明确的异常说明缺少必要的依赖

### 2.7 ChatClient 功能测试用例（可选）

#### TC-022: 测试 ChatClient 基本功能（需要 Mock）
- **测试目的**: 验证创建的 ChatClient 能否正常使用（需要 Mock API 调用）
- **测试步骤**:
  1. 配置 `spring.ai.deepseek.api-key=test-key`
  2. Mock `DeepSeekChatModel` 的响应
  3. 启动 Spring 上下文
  4. 获取 `deepSeekChatClient` Bean
  5. 调用 ChatClient 的方法（如 `prompt().call().entity()`）
  6. 验证能正常调用并返回结果
- **预期结果**: ChatClient 能正常使用，可以调用 AI 模型（需要 Mock）

#### TC-023: 测试不同 ChatClient 的独立性
- **测试目的**: 验证不同的 ChatClient 实例是独立的，互不影响
- **测试步骤**:
  1. 同时配置两个 api-key
  2. 启动 Spring 上下文
  3. 获取两个 ChatClient Bean
  4. 验证它们是不同的实例（使用 `!=` 比较）
  5. 验证它们可以独立使用（需要 Mock）
- **预期结果**: 两个 ChatClient 是独立的实例，可以独立使用

## 三、测试环境要求

1. **测试框架**: 
   - JUnit 5
   - Spring Boot Test
   - Mockito（用于 Mock ChatModel 和 API 调用）

2. **测试配置**:
   - 使用 `@TestConfiguration` 提供测试配置
   - 使用 `@SpringBootTest` 进行集成测试
   - 使用 `@MockBean` 模拟 `DeepSeekChatModel` 和 `ZhiPuAiChatModel`（如需要）
   - 使用 `@TestPropertySource` 或 `application-test.yml` 提供测试配置

3. **依赖要求**:
   - Spring AI DeepSeek Starter
   - Spring AI ZhiPuAI Starter
   - Spring Boot Test Starter

## 四、测试数据准备

1. **测试配置**: 准备多个测试配置文件，覆盖不同的配置场景
   - 只配置 DeepSeek api-key
   - 只配置 ZhiPuAI api-key
   - 同时配置两个 api-key
   - 不配置任何 api-key
   - 配置空字符串的 api-key

2. **Mock 数据**: 如果需要测试 ChatClient 的实际功能，需要 Mock：
   - `DeepSeekChatModel` 的响应
   - `ZhiPuAiChatModel` 的响应
   - HTTP 客户端（如果 Spring AI 使用 HTTP 调用）

## 五、测试用例与代码对应关系

### 5.1 待实现的测试用例

| 测试用例ID | 测试用例名称 | 建议实现类 | 状态 |
|-----------|------------|--------|------|
| TC-001 | 测试 ChatClientConfig Bean 创建 | ChatClientConfigTest | ⏳ 待实现 |
| TC-002 | 测试配置类上的 @Configuration 注解 | ChatClientConfigTest | ⏳ 待实现 |
| TC-003 | 测试 DeepSeek ChatClient Bean 创建（配置了 api-key） | DeepSeekChatClientTest | ⏳ 待实现 |
| TC-004 | 测试 DeepSeek ChatClient Bean 不创建（未配置 api-key） | DeepSeekChatClientTest | ⏳ 待实现 |
| TC-005 | 测试 DeepSeek ChatClient 条件注解匹配规则 | DeepSeekChatClientConditionalTest | ⏳ 待实现 |
| TC-006 | 测试 DeepSeek ChatClient 依赖注入 | DeepSeekChatClientDependencyTest | ⏳ 待实现 |
| TC-007 | 测试 DeepSeek ChatClient 配置属性 | DeepSeekChatClientPropertiesTest | ⏳ 待实现 |
| TC-008 | 测试 ZhiPuAI ChatClient Bean 创建（配置了 api-key） | ZhiPuAiChatClientTest | ⏳ 待实现 |
| TC-009 | 测试 ZhiPuAI ChatClient Bean 不创建（未配置 api-key） | ZhiPuAiChatClientTest | ⏳ 待实现 |
| TC-010 | 测试 ZhiPuAI ChatClient 条件注解匹配规则 | ZhiPuAiChatClientConditionalTest | ⏳ 待实现 |
| TC-011 | 测试 ZhiPuAI ChatClient 依赖注入 | ZhiPuAiChatClientDependencyTest | ⏳ 待实现 |
| TC-012 | 测试 ZhiPuAI ChatClient 配置属性 | ZhiPuAiChatClientPropertiesTest | ⏳ 待实现 |
| TC-013 | 测试同时配置两个 ChatClient | ChatClientCoexistenceTest | ⏳ 待实现 |
| TC-014 | 测试通过 Bean 名称获取不同的 ChatClient | ChatClientQualifierTest | ⏳ 待实现 |
| TC-015 | 测试只配置一个 ChatClient 时的 Bean 数量 | ChatClientSingleBeanTest | ⏳ 待实现 |
| TC-016 | 测试条件注解的 prefix 和 name 匹配 | ChatClientConditionalPropertyTest | ⏳ 待实现 |
| TC-017 | 测试条件注解的默认值处理 | ChatClientConditionalDefaultTest | ⏳ 待实现 |
| TC-018 | 测试配置属性为空字符串的处理 | ChatClientEmptyPropertyTest | ⏳ 待实现 |
| TC-019 | 测试缺少 ChatModel Bean 时的处理 | ChatClientMissingDependencyTest | ⏳ 待实现 |
| TC-020 | 测试配置错误的 base-url 时的处理 | ChatClientInvalidConfigTest | ⏳ 待实现 |
| TC-021 | 测试缺少依赖时的处理 | ChatClientMissingDependencyTest | ⏳ 待实现 |
| TC-022 | 测试 ChatClient 基本功能（需要 Mock） | ChatClientFunctionalityTest | ⏳ 待实现（可选） |
| TC-023 | 测试不同 ChatClient 的独立性 | ChatClientIndependenceTest | ⏳ 待实现（可选） |

### 5.2 测试类组织建议

1. **基础配置测试**:
   - `ChatClientConfigTest`: 测试配置类本身

2. **DeepSeek 相关测试**:
   - `DeepSeekChatClientTest`: 基础功能测试
   - `DeepSeekChatClientConditionalTest`: 条件注解测试
   - `DeepSeekChatClientPropertiesTest`: 配置属性测试

3. **ZhiPuAI 相关测试**:
   - `ZhiPuAiChatClientTest`: 基础功能测试
   - `ZhiPuAiChatClientConditionalTest`: 条件注解测试
   - `ZhiPuAiChatClientPropertiesTest`: 配置属性测试

4. **共存和交互测试**:
   - `ChatClientCoexistenceTest`: 多个 ChatClient 共存测试
   - `ChatClientQualifierTest`: Bean 名称和 Qualifier 测试

5. **异常场景测试**:
   - `ChatClientMissingDependencyTest`: 缺少依赖测试
   - `ChatClientInvalidConfigTest`: 无效配置测试

6. **功能测试（可选）**:
   - `ChatClientFunctionalityTest`: 实际功能测试（需要 Mock）

## 六、注意事项

1. **条件注解测试**: 
   - `@ConditionalOnProperty` 的默认行为是 `matchIfMissing = false`，即配置不存在时 Bean 不被创建
   - 空字符串通常被视为无效配置，Bean 也不会被创建

2. **依赖注入测试**:
   - `DeepSeekChatModel` 和 `ZhiPuAiChatModel` 是由 Spring AI Starter 自动配置创建的
   - 需要确保相关配置属性正确，才能创建对应的 ChatModel Bean

3. **测试隔离性**:
   - 每个测试类应该使用独立的测试配置，避免测试之间的相互影响
   - 使用 `@TestPropertySource` 或独立的 `application-test.yml` 文件

4. **Mock 使用**:
   - 如果测试实际的 ChatClient 功能，需要 Mock `ChatModel` 的响应
   - 避免在测试中实际调用外部 API，使用 Mock 或 Testcontainers（如果支持）

5. **配置属性验证**:
   - Spring AI 的配置属性可能在不同版本中有变化，需要根据实际使用的版本调整测试

6. **Bean 名称**:
   - 方法名 `deepSeekChatClient` 和 `zhiPuAiChatClient` 会作为 Bean 的名称
   - 可以通过 `@Qualifier` 注解指定 Bean 名称进行注入

7. **多个 ChatClient 共存**:
   - 两个 ChatClient Bean 可以同时存在，它们使用不同的 ChatModel
   - 注入时需要明确指定 Bean 名称，避免类型冲突

